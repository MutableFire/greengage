# --------------------------------------------------------------------
# GitHub Actions Workflow: Greenplum Build Pipeline
# --------------------------------------------------------------------

name: Greenplum Build

on:
  push:
    branches: [ "OPENGPDB_STABLE", "OPENGPDB_6_27_STABLE", "MDB_6_25_STABLE_YEZZEY" ]
  pull_request:
    branches: [ "OPENGPDB_STABLE", "OPENGPDB_6_27_STABLE", "MDB_6_25_STABLE_YEZZEY" ]

jobs:

  ## ======================================================================
  ## Job: prepare-test-matrix
  ## ======================================================================

  prepare-test-matrix:

    runs-on: ubuntu-latest

    outputs:
      test-matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - id: set-matrix
        run: |
          echo "=== Matrix Preparation Diagnostics ==="
          echo "Event type: ${{ github.event_name }}"
          echo "Test selection input: '${{ github.event.inputs.test_selection }}'"

          stat -fc %T /sys/fs/cgroup/

          # Define defaults
          DEFAULT_NUM_PRIMARY_MIRROR_PAIRS=3
          DEFAULT_ENABLE_CGROUPS=false
          DEFAULT_ENABLE_CORE_CHECK=true
          DEFAULT_INSTALL_TARGET=false
          DEFAULT_PG_SETTINGS_OPTIMIZER=""
          DEFAULT_RUNS_ON="ubuntu-latest"

          # Define base test configurations
          ALL_TESTS='{
            "include": [
              {"test":"ic-good-opt-off",
               "make_configs":["src/test/regress:installcheck-good"],
               "pg_settings":{"optimizer":"off"}
              },
              {"test":"ic-good-opt-on",
               "make_configs":["src/test/regress:installcheck-good"],
               "pg_settings":{"optimizer":"on"}
              },
              {"test":"ic-expandshrink",
               "make_configs":["src/test/isolation2:installcheck-expandshrink"]
              },
              {"test":"ic-resgroup",
               "make_configs":["src/test/isolation2:installcheck-resgroup"],
               "enable_cgroups":true,
               "runs_on":"ubuntu-20.04"
              },
              {"test":"ic-contrib",
               "install_target":true,
               "make_configs":["contrib/amcheck:installcheck",
                               "contrib/auto_explain:installcheck",
                               "contrib/btree_gin:installcheck",
                               "contrib/btree_gist:installcheck",
                               "contrib/citext:installcheck",
                               "contrib/cube:installcheck",
                               "contrib/dblink:installcheck",
                               "contrib/dict_int:installcheck",
                               "contrib/dict_xsyn:installcheck",
                               "contrib/earthdistance:installcheck",
                               "contrib/extprotocol:installcheck",
                               "contrib/file_fdw:installcheck",
                               "contrib/formatter_fixedwidth:installcheck",
                               "contrib/fuzzystrmatch:installcheck",
                               "contrib/hstore:installcheck",
                               "contrib/indexscan:installcheck",
                               "contrib/intarray:installcheck",
                               "contrib/isn:installcheck",
                               "contrib/ltree:installcheck",
                               "contrib/passwordcheck:installcheck",
                               "contrib/pg_trgm:installcheck",
                               "contrib/pgcrypto:installcheck",
                               "contrib/pgstattuple:installcheck",
                               "contrib/postgres_fdw:installcheck",
                               "contrib/sasdemo:installcheck",
                               "contrib/sepgsql:installcheck",
                               "contrib/sslinfo:installcheck",
                               "contrib/tablefunc:installcheck",
                               "contrib/test_decoding:installcheck",
                               "contrib/test_parser:installcheck",
                               "contrib/test_shm_mq:installcheck",
                               "contrib/try_convert:installcheck",
                               "contrib/tsearch2:installcheck",
                               "contrib/unaccent:installcheck",
                               "contrib/uuid-ossp:installcheck",
                               "contrib/xml2:installcheck"]
              },
              {"test":"ic-gpcontrib",
               "make_configs":["gpcontrib/gp_array_agg:installcheck",
                               "gpcontrib/gp_debug_numsegments:installcheck",
                               "gpcontrib/gp_distribution_policy:installcheck",
                               "gpcontrib/gp_error_handling:installcheck",
                               "gpcontrib/gp_inject_fault:installcheck",
                               "gpcontrib/gp_internal_tools:installcheck",
                               "gpcontrib/gp_legacy_string_agg:installcheck",
                               "gpcontrib/gp_percentile_agg:installcheck",
                               "gpcontrib/gp_sparse_vector:installcheck",
                               "gpcontrib/gp_subtransaction_overflow:installcheck",
                               "gpcontrib/gpcloud:installcheck",
                               "gpcontrib/gpmapreduce:installcheck",
                               "gpcontrib/orafce:installcheck",
                               "gpcontrib/pgaudit:installcheck",
                               "gpcontrib/quicklz:installcheck",
                               "gpcontrib/sr_plan",
                               "gpcontrib/zstd"]
              },
              {"test":"ic-parallel-retrieve-cursor",
               "make_configs":["src/test/isolation2:installcheck-parallel-retrieve-cursor"]
              },
              {"test":"ic-mirrorless",
               "make_configs":["src/test/isolation2:installcheck-mirrorless"]
              }
            ]
          }'

          # Function to apply defaults
          apply_defaults() {
            echo "$1" | jq --arg     npm "$DEFAULT_NUM_PRIMARY_MIRROR_PAIRS" \
                           --argjson ec  "$DEFAULT_ENABLE_CGROUPS" \
                           --argjson ecc "$DEFAULT_ENABLE_CORE_CHECK" \
                           --argjson emk "$DEFAULT_INSTALL_TARGET" \
                           --arg     opt "$DEFAULT_PG_SETTINGS_OPTIMIZER" \
                           --arg     ro  "$DEFAULT_RUNS_ON" \
              'def get_defaults:
                {
                  num_primary_mirror_pairs: ($npm|tonumber),
                  enable_cgroups: $ec,
                  install_target: $emk,
                  runs_on: $ro,
                  enable_core_check: $ecc,
                  pg_settings: {
                    optimizer: $opt
                  }
                };
               get_defaults * .'
          }

          # Extract all valid test names from ALL_TESTS
          VALID_TESTS=$(echo "$ALL_TESTS" | jq -r '.include[].test')

          # Parse input test selection
          IFS=',' read -ra SELECTED_TESTS <<< "${{ github.event.inputs.test_selection }}"

          # Default to all tests if selection is empty or 'all'
          if [[ "${SELECTED_TESTS[*]}" == "all" || -z "${SELECTED_TESTS[*]}" ]]; then
            mapfile -t SELECTED_TESTS <<< "$VALID_TESTS"
          fi

          # Validate and filter selected tests
          INVALID_TESTS=()
          FILTERED_TESTS=()
          for TEST in "${SELECTED_TESTS[@]}"; do
            TEST=$(echo "$TEST" | tr -d '[:space:]') # Trim whitespace
            if echo "$VALID_TESTS" | grep -qw "$TEST"; then
              FILTERED_TESTS+=("$TEST")
            else
              INVALID_TESTS+=("$TEST")
            fi
          done

          # Handle invalid tests
          if [[ ${#INVALID_TESTS[@]} -gt 0 ]]; then
            echo "::error::Invalid test(s) selected: ${INVALID_TESTS[*]}"
            echo "Valid tests are: $(echo "$VALID_TESTS" | tr '\n' ', ')"
            exit 1
          fi

          # Build result JSON with defaults applied
          RESULT='{"include":['
          FIRST=true
          for TEST in "${FILTERED_TESTS[@]}"; do
            CONFIG=$(jq -c --arg test "$TEST" '.include[] | select(.test == $test)' <<< "$ALL_TESTS")
            FILTERED_WITH_DEFAULTS=$(apply_defaults "$CONFIG")
            if [[ "$FIRST" == true ]]; then
              FIRST=false
            else
              RESULT="${RESULT},"
            fi
            RESULT="${RESULT}${FILTERED_WITH_DEFAULTS}"
          done
          RESULT="${RESULT}]}"

          # Output the matrix for GitHub Actions
          echo "Final matrix configuration:"
          echo "$RESULT" | jq .

          # Fix: Use block redirection
          {
            echo "matrix<<EOF"
            echo "$RESULT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "=== Matrix Preparation Complete ==="

  ## ======================================================================
  ## Job: init-docker-env
  ## ======================================================================



  ## ======================================================================
  ## Job: build
  ## ======================================================================

  build:
    env:
      JOB_TYPE: build
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      build_timestamp: ${{ steps.set_timestamp.outputs.timestamp }}

    container:
      image: ghcr.io/open-gpdb/gpdb-env:jammy-latest

    steps:
      - name: Set build timestamp
        id: set_timestamp  # Add an ID to reference this step
        run: |
          timestamp=$(date +'%Y%m%d_%H%M%S')
          echo "timestamp=$timestamp" | tee -a "$GITHUB_OUTPUT"  # Use GITHUB_OUTPUT for job outputs
          echo "BUILD_TIMESTAMP=$timestamp" | tee -a "$GITHUB_ENV" # Also set as environment variable

      - name: Checkout Greenplum
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Checkout CI Build/Test Scripts
        uses: actions/checkout@v4
        with:
          repository: open-gpdb/gpdb-devops
          ref: main
          path: gpdb-devops
          fetch-depth: 1
      
      - name: Move gpdb-devops directory
        run: |
          set -ex pipefail
          if ! mv "${GITHUB_WORKSPACE}"/gpdb-devops "${GITHUB_WORKSPACE}"/..; then
            echo "::error::Container initialization failed"
            exit 1
          fi

      - name: Environment Initialization
        if: needs.check-skip.outputs.should_skip != 'true'
        env:
          LOGS_DIR: build-logs
        run: |
          set -ex pipefail

          export LOGS_DIR=build-logs

          mkdir -p "${LOGS_DIR}/details"
          sudo chmod -R 755 .
          chmod 777 "${LOGS_DIR}"

          df -h | tee -a "${LOGS_DIR}/details/disk-usage.log"
          free -h | tee -a "${LOGS_DIR}/details/memory-usage.log"

          {
            echo "=== Environment Information ==="
            uname -a
            df -h
            free -h
            env
          } | tee -a "${LOGS_DIR}/details/environment.log"

          echo "SRC_DIR=${GITHUB_WORKSPACE}" | tee -a "$GITHUB_ENV"

      - name: Generate Build Job Summary Start
        run: |
          {
            echo "# Build Job Summary"
            echo "## Environment"
            echo "- Start Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "- ENABLE_DEBUG: ${{ env.ENABLE_DEBUG }}"
            echo "- OS Version: $(lsb_release -sd)"
            echo "- GCC Version: $(gcc --version | head -n1)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Greenplum configure script
        env:
          SRC_DIR: ${{ github.workspace }}
        run: |
          set -ex pipefail

          # set env for debian build
          export BUILD_DESTINATION=${SRC_DIR}/debian/build

          chmod +x "${SRC_DIR}"/../gpdb-devops/build_automation/gpdb/scripts/configure-gpdb.sh

          cd ${SRC_DIR}
          if ! SRC_DIR=${SRC_DIR} ENABLE_DEBUG=${{ env.ENABLE_DEBUG }} ${SRC_DIR}/../gpdb-devops/build_automation/gpdb/scripts/configure-gpdb.sh; then
            echo "::error::Configure script failed"
            exit 1
          fi

      - name: Run Greenplum build script
        env:
          SRC_DIR: ${{ github.workspace }}
        run: |
          set -ex pipefail

          # set env for debian build
          export BUILD_DESTINATION=${SRC_DIR}/debian/build

          chmod +x "${SRC_DIR}"/../gpdb-devops/build_automation/gpdb/scripts/build-gpdb.sh
          cd ${SRC_DIR}
          if ! SRC_DIR=${SRC_DIR} ${SRC_DIR}/../gpdb-devops/build_automation/gpdb/scripts/build-gpdb.sh; then
            echo "::error::Build script failed"
            exit 1
          fi

          # copy sugar and xerces shared libraries
          if ! cp /usr/local/lib/libsigar.so ${BUILD_DESTINATION}/lib; then
            echo "::error::Copy libsigar.so failed"
            exit 1
          fi 

          if ! cp /usr/local/lib/libxerces* ${BUILD_DESTINATION}/lib; then
            echo "::error::Copy libxerces failed"
            exit 1
          fi

      - name: Verify build artifacts
        if: needs.check-skip.outputs.should_skip != 'true'
        run: |
          set -ex pipefail

          export BUILD_DESTINATION=${SRC_DIR}/debian/build

          echo "Verifying build artifacts..."
          {
            echo "=== Build Artifacts Verification ==="
            echo "Timestamp: $(date -u)"

            export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${BUILD_DESTINATION}/lib

            if [ ! -d "${BUILD_DESTINATION}" ]; then
              echo "::error::Build artifacts directory not found"
              exit 1
            fi

            # Verify critical binaries
            critical_binaries="${BUILD_DESTINATION}/bin/postgres ${BUILD_DESTINATION}/bin/psql"

            echo "Checking critical binaries..."
            for binary in ${critical_binaries}; do
              if [ ! -f "$binary" ]; then
                echo "::error::Critical binary missing: $binary"
                exit 1
              fi
              if [ ! -x "$binary" ]; then
                echo "::error::Binary not executable: $binary"
                exit 1
              fi
              echo "Binary verified: $binary"
              ls -l "$binary"
            done

            # Test binary execution
            echo "Testing binary execution..."
            if ! ${BUILD_DESTINATION}/bin/postgres --version; then
              echo "::error::postgres binary verification failed"
              exit 1
            fi
            if ! ${BUILD_DESTINATION}/bin/psql --version; then
              echo "::error::psql binary verification failed"
              exit 1
            fi

            echo "All build artifacts verified successfully"
          } 2>&1 | tee -a build-logs/details/build-verification.log

      - name: Run Greenplum debian package build script
        env:
          GPDB_VERSION: ${{ github.ref_name }}
          BUILD_NUMBER: 1
          SRC_DIR: ${{ github.workspace }}
        run: |
          set -ex pipefail

          echo "Creating DEB package..."

          echo "=== Artifact Creation Log ==="
          echo "Timestamp: $(date -u)"

          sudo cp -r "${SRC_DIR}"/../gpdb-devops/packaging/deb/jammy/debian/* debian/
          sudo chown -R "$(whoami)" debian

          # replace not supported symbols in version
          GPDB_VERSION=$(echo "$GPDB_VERSION" | sed "s/\//./g")
          echo "We will built ${GPDB_VERSION}"
          export BUILD_DESTINATION=${SRC_DIR}/debian/build
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${BUILD_DESTINATION}/lib

          chmod +x "${SRC_DIR}"/../gpdb-devops/scripts/build-deb.sh
          if ! ${SRC_DIR}/../gpdb-devops/scripts/build-deb.sh -v $GPDB_VERSION; then
            echo "::error::Build script failed"
            exit 1
          fi

          ARCH="amd64"
          GPDB_PKG_VERSION=${GPDB_VERSION}-${BUILD_NUMBER}-yandex.$(git --git-dir=.git rev-list HEAD --count).$(git --git-dir=.git rev-parse --short HEAD)

          echo "Produced artifacts"
          ls -l ../

          echo "Copy artifacts to current directory"
          DEB_FILE="greenplum-db-6_${GPDB_PKG_VERSION}"_"${ARCH}".deb
          DBG_DEB_FILE="greenplum-db-6-dbgsym_${GPDB_PKG_VERSION}"_"${ARCH}".ddeb
          CHANGES_FILE="greenplum-db-6_${GPDB_PKG_VERSION}"_"${ARCH}".changes
          SOURCE_FILE="greenplum-db-6_${GPDB_PKG_VERSION}".tar.xz
          cp ../"${DEB_FILE}" "${SRC_DIR}"
          cp ../"${DBG_DEB_FILE}" "${SRC_DIR}"
          cp ../"${CHANGES_FILE}" "${SRC_DIR}"
          cp ../"${SOURCE_FILE}" "${SRC_DIR}"

          # Get package information
          echo "Package Information:"
          dpkg --info "${DEB_FILE}"
          dpkg --contents "${DEB_FILE}"

          # Verify critical files in DEB
          echo "Verifying critical files in DEB..."
          for binary in "bin/postgres" "bin/psql"; do
            if ! dpkg --contents "${DEB_FILE}" | grep -q "${binary}$"; then
              echo "::error::Critical binary '${binary}' not found in DEB"
              exit 1
            fi
          done

          # Record checksums
          echo "Calculating checksums..."
          sha256sum "${DEB_FILE}" | tee -a build-logs/details/checksums.log

          echo "Artifacts created and verified successfully"

      - name: Generate Build Job Summary End
        if: always()
        run: |
          {
            echo "## Build Results"
            echo "- End Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Debian Packages
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages-${{ env.BUILD_TIMESTAMP }}
          path: |
            *.deb
            *.ddeb
            *.changes
            *.tar.xz

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.BUILD_TIMESTAMP }}
          path: |
            build-logs/
          retention-days: ${{ env.LOG_RETENTION_DAYS }}


